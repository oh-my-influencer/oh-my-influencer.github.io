name: Update Influencer Data

on:
  schedule:
    - cron: "0 15 * * *"   # 매일 UTC 15:00 = KST 00:00
  workflow_dispatch:        # 수동 실행 버튼도 활성화

jobs:
  update-data:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python
        run: uv python install

      - name: Install dependencies
        run: uv sync

      - name: Fetch YouTube data
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        run: uv run python scripts/fetch_youtube.py

      - name: Fetch Instagram data (Apify)
        env:
          APIFY_API_TOKEN: ${{ secrets.APIFY_API_TOKEN }}
        run: uv run python scripts/fetch_instagram.py

      - name: Merge data
        run: uv run python scripts/merge.py

      - name: Commit & push updated data
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/influencers.json data/youtube.json data/instagram.json
          git diff --cached --quiet || git commit -m "chore: update influencers.json [$(date -u '+%Y-%m-%d %H:%M UTC')]"
          git push

      - name: Print summary
        run: |
          COUNT=$(uv run python -c "import json; d=json.load(open('data/influencers.json')); print(d['count'])")
          echo "✅ 인플루언서 ${COUNT}명 저장 완료"